name: Auto PR Description

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  generate-description:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get diff
        id: diff
        run: |
          git fetch origin ${{ github.base_ref }}
          git diff origin/${{ github.base_ref }} > diff.txt
          echo "DIFF<<EOF" >> $GITHUB_ENV
          cat diff.txt >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Generate PR Body
        id: generate
        uses: actions/github-script@v7
        with:
          script: |
            const diff = process.env.DIFF;

            const body = `
            ## 概要
            このPRは以下の変更を含みます。

            ## 変更内容
            ${diff.substring(0, 3000)}

            ## 変更理由
            -

            ## 動作確認
            -

            ## 影響範囲
            -
            `;

            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              body: body
            });
